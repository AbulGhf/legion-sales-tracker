<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Legion Sale Trackers</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&display=swap');
        
        /* Modern background gradient for the entire page */
        body {
            background: linear-gradient(135deg, #0f0f14 0%, #151520 50%, #1a1a25 100%);
            color: white;
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
        }

        /* Update header with gradient */
        .main-header {
            background: linear-gradient(90deg, #13131f 0%, #1f1f2c 100%);
            border-bottom: 1px solid #FF5722;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            padding: 0.75rem 0;
            margin-bottom: 1rem;
            position: relative;
            width: 100%;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        /* Logo image styling */
        .header-logo-image {
            height: 40px;
            margin-right: 0.75rem;
        }

        .header-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #e0e0e0;
            text-shadow: 0 0 15px rgba(255, 87, 34, 0.4);
            margin-right: auto; /* Push it to the left */
        }
        
        .header-nav {
            display: flex;
            align-items: center;
            margin-left: 1rem;
        }
        
        .nav-button {
            background: linear-gradient(145deg, #2a2a3d 0%, #333348 100%);
            border: 1px solid #FF5722;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .nav-button:hover {
            background: linear-gradient(145deg, #333348 0%, #3a3a52 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }

        /* New container layout styles */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            background: linear-gradient(0deg, rgba(20, 20, 30, 0.3) 0%, rgba(15, 15, 25, 0.3) 100%);
            border-radius: 12px;
            border: 1px solid rgba(255, 87, 34, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        /* Adjust spacing between main sections */
        .top-section {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .bottom-section {
            margin-bottom: 1rem;
        }

        /* Consistent bottom section height */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            height: 450px;
        }

        .stats-row .stats-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Card styling with gradients */
        .stats-card {
            background: linear-gradient(145deg, #15151f 0%, #1a1a25 100%);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 87, 34, 0.1);
            position: relative;
            overflow: hidden;
        }

        /* Full-width stats cards for better space usage */
        .left-column .stats-card {
            margin-bottom: 1rem;
        }

        /* Enhanced live feed - taller */
        .live-feed-card {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .stats-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Center chart titles and make them larger */
        #investor-count .stats-title {
            font-size: 1.3rem;
            text-align: center;
            justify-content: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
        }

        #investment-distribution .stats-title {
            font-size: 1.3rem;
            text-align: center;
            justify-content: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
        }

        .stats-title i {
            font-size: 1rem;
            color: #666666;
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        /* Stats items with gradients */
        .stat-item {
            background: linear-gradient(145deg, #1d1d28 0%, #242433 100%);
            border-radius: 8px;
            padding: 1.25rem 1rem;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            font-size: 0.875rem;
            color: #b0b0b0;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #FF5722;
        }

        .stat-value.legion-stat {
            color: #FF5722;
        }

        /* Make charts take up all available space */
        .chart-container {
            flex: 1;
            position: relative;
            height: auto !important;
            margin-top: 0;
        }

        /* Investor count chart - make bars taller */
        #investor-chart-container {
            height: 90%; 
            margin-top: 1rem;
        }

        /* Table container with fixed headers */
        .table-container {
            background: linear-gradient(145deg, #15151f 0%, #1a1a25 100%);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 87, 34, 0.1);
            position: relative;
        }

        /* Table scroll container */
        .table-scroll-container {
            flex: 1;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #FF5722 #242433;
        }

        .table-content {
            min-width: 900px;
        }

        /* Table header */
        .table-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #1a1a25;
            border-bottom: 1px solid rgba(255, 87, 34, 0.2);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Table row */
        .table-row {
            display: grid;
            grid-template-columns: 60px minmax(140px, 0.8fr) minmax(140px, 1fr) minmax(100px, 0.6fr) minmax(100px, 0.6fr) minmax(100px, 0.6fr) 120px;
            padding: 0.75rem 1rem;
            align-items: center;
            transition: all 0.2s ease;
            position: relative;
        }

        /* Remove unused styles */
        .table-header-container,
        .table-body {
            display: none;
        }

        /* Mobile styles */
        @media screen and (max-width: 768px) {
            .table-content {
                min-width: 900px;
            }

            .table-scroll-container {
                overflow: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-header {
                position: sticky;
                top: 0;
                z-index: 10;
                background: #1a1a25;
            }
        }

        .filter-bar {
            background: linear-gradient(90deg, #1d1d28 0%, #242433 100%);
            border-bottom: 1px solid #2a2a3a;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #FF5722 #242433;
        }

        .filter-bar::-webkit-scrollbar {
            height: 4px;
        }

        .filter-bar::-webkit-scrollbar-track {
            background: #242433;
        }

        .filter-bar::-webkit-scrollbar-thumb {
            background-color: #FF5722;
            border-radius: 3px;
        }

        .filter-button {
            background: linear-gradient(145deg, #1d1d28 0%, #242433 100%);
            border: 1px solid #333343;
            color: #e0e0e0;
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            margin-right: 4px;
        }

        .filter-button:hover {
            background: linear-gradient(145deg, #242433 0%, #2a2a3d 100%);
            border-color: #FF5722;
            transform: translateY(-2px);
        }

        .filter-button.active {
            background: linear-gradient(145deg, #2a2a3d 0%, #333348 100%);
            border-color: #FF5722;
            color: #ffffff;
            box-shadow: 0 2px 8px rgba(255, 87, 34, 0.2);
        }

        .search-container {
            margin-left: auto;
            position: relative;
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
            width: 200px;
        }

        /* Search input styling */
        .search-input {
            background: linear-gradient(145deg, #1d1d28 0%, #242433 100%);
            border: 1px solid #333343;
            color: #ffffff;
            padding: 0.35rem 1rem 0.35rem 2.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            width: 100%;
        }

        .search-input:focus {
            outline: none;
            border-color: #FF5722;
            box-shadow: 0 0 0 2px rgba(255, 87, 34, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #777777;
        }

        /* Table body */
        .table-body {
            width: 100%;
            overflow-y: visible;
        }

        .table-body::-webkit-scrollbar {
            width: 6px;
        }

        .table-body::-webkit-scrollbar-track {
            background: #242433;
            border-radius: 3px;
        }

        .table-body::-webkit-scrollbar-thumb {
            background-color: #FF5722;
            border-radius: 3px;
        }

        /* Updated table row - removed bottom border */
        .table-row {
            display: grid;
            grid-template-columns: 60px minmax(140px, 0.8fr) minmax(140px, 1fr) minmax(100px, 0.6fr) minmax(100px, 0.6fr) minmax(100px, 0.6fr) 120px;
            padding: 0.75rem 1rem;
            align-items: center;
            transition: all 0.2s ease;
            min-width: 900px; /* Ensure minimum width for scrolling */
            border-bottom: none; /* Remove the black border patterns */
            position: relative;
        }

        /* Updated table row hover effect - cleaner, with subtle highlight */
        .table-row:hover {
            background: rgba(255, 87, 34, 0.05);
        }

        /* Add subtle separators between rows instead of dark borders */
        .table-row:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 1rem;
            right: 1rem;
            bottom: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Loading skeleton */
        .skeleton-row {
            display: grid;
            grid-template-columns: 60px minmax(140px, 0.8fr) minmax(140px, 1fr) minmax(100px, 0.6fr) minmax(100px, 0.6fr) minmax(100px, 0.6fr) 120px;
            padding: 0.75rem 1rem;
            align-items: center;
            position: relative;
            height: 64px;
        }

        .skeleton-row:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 1rem;
            right: 1rem;
            bottom: 0;
            height: 1px;
            background: rgba(255, 255, 255, 0.05);
        }

        .skeleton {
            background: linear-gradient(90deg, #222 0%, #333 50%, #222 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .skeleton-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .skeleton-text {
            height: 18px;
            width: 80%;
        }

        .skeleton-text-lg {
            height: 24px;
            width: 70%;
        }

        .skeleton-button {
            height: 32px;
            width: 120px;
        }

        /* Logo styling */
        .logo-container {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sale-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
            border-radius: 8px;
        }

        /* Name styling */
        .sale-name {
            font-size: 1.125rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        /* Amount styling */
        .sale-amount {
            font-size: 1.125rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        /* Investor count styling */
        .sale-investors {
            font-size: 1.125rem;
            font-weight: 600;
        }

        /* Token price styling */
        .token-sale-price, .token-price {
            font-size: 1.125rem;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Price indicator */
        .loading-price {
            font-size: 0.875rem;
            color: #777;
            font-style: italic;
        }

        .not-live {
            font-size: 0.95rem;
            color: #999;
            font-weight: 500;
        }

        /* Action button styling */
        .action-button {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            font-weight: 600;
            text-align: center;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }

        /* Live feed card special styling */
        .live-feed {
            max-height: 350px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #FF5722 #242433;
            flex: 1;
        }

        .live-feed::-webkit-scrollbar {
            width: 6px;
        }

        .live-feed::-webkit-scrollbar-track {
            background: #242433;
            border-radius: 3px;
        }

        .live-feed::-webkit-scrollbar-thumb {
            background-color: #FF5722;
            border-radius: 3px;
        }

        .feed-item {
            background: rgba(40, 40, 40, 0.6);
            margin: 4px;
            border-radius: 4px;
            padding: 10px 15px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .feed-item:hover {
            background: rgba(50, 50, 50, 0.8);
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-logo {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 12px;
        }

        .feed-address {
            color: #b0b0b0;
            font-family: monospace;
            text-decoration: none;
            transition: color 0.2s ease;
            flex: 1;
        }

        .feed-address:hover {
            color: #ffffff;
            text-decoration: underline;
        }

        .feed-amount {
            font-weight: 700;
            margin-left: auto;
            margin-right: 10px;
            font-family: monospace;
        }

        .feed-time {
            color: #777;
            font-size: 0.75rem;
            width: 60px;
            text-align: right;
        }

        /* Project-specific styles */
        .almanak-row {
            border-left: 3px solid #a0c4ff;
        }

        .almanak-color {
            color: #a0c4ff;
        }

        .almanak-button {
            background-color: #a0c4ff;
            color: #000000;
        }

        .almanak-button:hover {
            background-color: #b8d3ff;
        }

        /* Giza - changed from cream to gold/amber */
        .giza-row {
            border-left: 3px solid #ffd166;
        }

        .giza-color {
            color: #ffd166;
        }

        .giza-button {
            background-color: #ffd166;
            color: #000000;
        }

        .giza-button:hover {
            background-color: #ffda85;
        }
        
        /* Skate Chain */
        .skate-row {
            border-left: 3px solid #c5ff33;
        }
        
        .skate-color {
            color: #c5ff33;
        }
        
        .skate-button {
            background-color: #c5ff33;
            color: #000000;
        }
        
        .skate-button:hover {
            background-color: #d2ff5c;
        }
        
        /* Pulse */
        .pulse-row {
            border-left: 3px solid #b14aff;
        }
        
        .pulse-color {
            color: #b14aff;
        }
        
        .pulse-button {
            background-color: #b14aff;
            color: #ffffff;
        }
        
        .pulse-button:hover {
            background-color: #c06fff;
        }
        
        /* FUEL */
        .fuel-row {
            border-left: 3px solid #00f58c;
        }
        
        .fuel-color {
            color: #00f58c;
        }
        
        .fuel-button {
            background-color: #00f58c;
            color: #000000;
        }
        
        .fuel-button:hover {
            background-color: #34f9a7;
        }
        
        /* Electron */
        .electron-row {
            border-left: 3px solid #92c2ff;
        }
        
        .electron-color {
            color: #92c2ff;
        }
        
        .electron-button {
            background-color: #92c2ff;
            color: #000000;
        }
        
        .electron-button:hover {
            background-color: #aad0ff;
        }
        
        /* corn */
        .corn-row {
            border-left: 3px solid #ff931e;
        }
        
        .corn-color {
            color: #ff931e;
        }
        
        .corn-button {
            background-color: #ff931e;
            color: #000000;
        }
        
        .corn-button:hover {
            background-color: #ffa545;
        }
        
        /* Enclave */
        .enclave-row {
            border-left: 3px solid #60c2ff;
        }
        
        .enclave-color {
            color: #60c2ff;
        }
        
        .enclave-button {
            background-color: #60c2ff;
            color: #000000;
        }
        
        .enclave-button:hover {
            background-color: #84d0ff;
        }
        
        .nil-row {
            border-left: 3px solid #c9b6e4;
        }

        .nil-color {
            color: #c9b6e4;
        }

        .nil-button {
            background-color: #323232;
            color: #ffffff;
        }

        .nil-button:hover {
            background-color: #424242;
        }

        /* Silencio */
        .silencio-row {
            border-left: 3px solid #284ee9;
        }
        
        .silencio-color {
            color: #284ee9;
        }
        
        .silencio-button {
            background-color: #284ee9;
            color: #ffffff;
        }
        
        .silencio-button:hover {
            background-color: #4367f0;
        }

        /* Lit Protocol - New Style */
        .lit-row {
            border-left: 3px solid #fd7244;
        }
        
        .lit-color {
            color: #fd7244;
        }
        
        .lit-button {
            background-color: #fd7244;
            color: #000000;
        }
        
        .lit-button:hover {
            background-color: #fd8c66;
        }

        /* Session */
        .session-row {
            border-left: 3px solid #24f2d2;
        }
        
        .session-color {
            color: #24f2d2;
        }
        
        .session-button {
            background-color: #24f2d2;
            color: #000000;
        }
        
        .session-button:hover {
            background-color: #50f5dc;
        }

        /* Fragmetric */
        .fragmetric-row {
            border-left: 3px solid #007d3a;
        }
        
        .fragmetric-color {
            color: #007d3a;
        }
        
        .fragmetric-button {
            background-color: #007d3a;
            color: #ffffff;
        }
        
        .fragmetric-button:hover {
            background-color: #009447;
        }

        /* Resolv */
        .resolv-row {
            border-left: 3px solid #6696ae;
        }
        
        .resolv-color {
            color: #6696ae;
        }
        
        .resolv-button {
            background-color: #6696ae;
            color: #ffffff;
        }
        
        .resolv-button:hover {
            background-color: #7aa7bd;
        }

        /* Hyperlane */
        .hyperlane-row {
            border-left: 3px solid #2262c0;
        }
        
        .hyperlane-color {
            color: #2262c0;
        }
        
        .hyperlane-button {
            background-color: #2262c0;
            color: #ffffff;
        }
        
        .hyperlane-button:hover {
            background-color: #3a75cb;
        }

        /* eOracle */
        .eoracle-row {
            border-left: 3px solid #1b6a58;
        }
        
        .eoracle-color {
            color: #1b6a58;
        }
        
        .eoracle-button {
            background-color: #1b6a58;
            color: #ffffff;
        }
        
        .eoracle-button:hover {
            background-color: #267d68;
        }

        /* Overlay */
        .overlay-row {
            border-left: 3px solid #545454;
        }
        
        .overlay-color {
            color: #545454;
        }
        
        .overlay-button {
            background-color: #545454;
            color: #ffffff;
        }
        
        .overlay-button:hover {
            background-color: #666666;
        }

        /* Upcoming badge */
        .upcoming-badge {
            display: inline-block;
            background: rgba(255, 87, 34, 0.2);
            border: 1px solid rgba(255, 87, 34, 0.3);
            color: #FF5722;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Live badge */
        .live-badge {
            display: inline-block;
            background: rgba(50, 205, 50, 0.2);
            border: 1px solid rgba(50, 205, 50, 0.3);
            color: #32CD32;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Mobile breakpoints */
        @media screen and (max-width: 992px) {
            .top-section {
                display: block;
            }
            
            .dashboard-container {
                padding: 0.75rem;
                border-radius: 8px;
            }
            
            .left-column, .right-column {
                width: 100%;
                max-width: 600px;
                margin: 0 auto;
            }
        }
        
        @media screen and (max-width: 580px) {
            .header-title {
                font-size: 1.3rem;
                letter-spacing: 0.5px;
            }
            
            .header-logo-image {
                height: 25px;
            }
            
            .filter-button {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem;
            }
            
            .action-button {
                font-size: 0.75rem;
                padding: 0.3rem 0.5rem;
            }
            
            .nav-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        /* Override media queries to prevent stretching in mobile */
        @media screen and (max-width: 768px) {
            .container {
                width: 100%;
                padding: 0 10px;
            }
            
            .top-section {
                display: block;
            }
            
            .stats-row {
                display: block;
                height: auto;
            }
            
            .left-column {
                width: 100%;
                margin: 0 auto;
                overflow: visible;
            }
            
            .right-column {
                width: 100%;
                margin: 0 auto;
            }
            
            /* Fixed sizes for mobile cards to match desktop proportion */
            .live-feed-card {
                width: 100%;
                max-width: 380px;
                margin: 0 auto 1rem auto;
                height: 400px;
            }
            
            .stats-card:not(.live-feed-card) {
                width: 100%;
                max-width: 380px;
                margin: 0 auto 1rem auto;
            }
            
            .stats-row .stats-card {
                height: 400px;
                margin: 0 auto 1rem auto;
                max-width: 500px;
            }
            
            /* Preserve chart aspect ratio */
            .chart-container {
                min-height: 300px;
            }
            
            /* Fixed filter bar */
            .filter-bar {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            /* Fixed header for mobile */
            .table-header-container {
                position: sticky;
                top: 0;
                z-index: 10;
                min-width: 900px;
                background: #1a1a25;
            }
            
            .table-scroll-container {
                overflow-x: auto;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-body {
                min-width: 900px;
            }
            
            /* Header adjustments */
            .header-logo-image {
                height: 30px;
            }
            
            .header-title {
                font-size: 1.5rem;
            }
            
            .nav-button {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        @media screen and (max-width: 580px) {
            .header-title {
                font-size: 1.2rem;
                letter-spacing: 0.5px;
            }
            
            .header-logo-image {
                height: 28px;
            }
            
            /* Keep the 2-column layout for stats on mobile */
            .stat-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .stats-title {
                font-size: 1rem;
            }
            
            #investor-count .stats-title,
            #investment-distribution .stats-title {
                font-size: 1.1rem;
            }
            
            .sale-name {
                font-size: 0.95rem;
            }
            
            .sale-amount {
                font-size: 0.95rem;
            }
            
            .action-button {
                font-size: 0.75rem;
                padding: 0.3rem 0.5rem;
            }
            
            .dashboard-container {
                padding: 0.5rem;
                border-radius: 6px;
            }
        }
        
        @media screen and (max-width: 400px) {
            .header-title {
                font-size: 1rem;
            }
            
            .header-logo-image {
                height: 24px;
            }
            
            .action-button {
                width: 100%;
                text-align: center;
            }
            
            .nav-button {
                font-size: 0.7rem;
                padding: 0.3rem 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Cache busting script -->
    <script>
        // Set a deployment timestamp - update this when you deploy
        const DEPLOYMENT_TIME = Date.now();
        const LAST_VISIT_KEY = 'last_visited_time';
        
        // Get the last visit time
        const lastVisit = localStorage.getItem(LAST_VISIT_KEY);
        
        // If this is a new deployment and not the first visit, reload the page
        if (lastVisit && parseInt(lastVisit) < DEPLOYMENT_TIME) {
            // Clear cache and reload
            localStorage.setItem(LAST_VISIT_KEY, DEPLOYMENT_TIME.toString());
            window.location.reload(true);
        } else {
            // Update the last visit time
            localStorage.setItem(LAST_VISIT_KEY, DEPLOYMENT_TIME.toString());
        }
    </script>
    
    <!-- Header -->
    <header class="main-header">
        <div class="container mx-auto px-4">
            <div class="header-content">
                <img src="/legion.png" alt="Legion" class="header-logo-image">
                <h1 class="header-title">LEGION SALE TRACKERS</h1>
                <div class="header-nav">
                    <a href="/top-investors.html" class="nav-button">
                        <i class="fas fa-users mr-2"></i> Top Investors
                    </a>
                    <a href="/sales-roi.html" class="nav-button ml-2">
                        <i class="fas fa-chart-line mr-2"></i> Sales ROI
                    </a>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4">
        <div class="dashboard-container">
            <!-- Top section -->
            <div class="top-section">
                <!-- Left Column - Stats and Charts -->
                <div class="left-column">
                    <!-- Live Feed - Taller -->
                    <div class="stats-card live-feed-card">
                        <div class="text-center text-gray-400 py-12 text-lg font-semibold">
                            No live sales
                        </div>
                    </div>
                    
                    <!-- Combined Legion Stats Card -->
                    <div class="stats-card">
                        <div class="stats-title">
                            <span>Legion Stats Dashboard</span>
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="stat-grid">
                            <div class="stat-item">
                                <div class="stat-label">Total Investment</div>
                                <div class="stat-value legion-stat" id="total-investment">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total Investments</div>
                                <div class="stat-value legion-stat" id="total-investors">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Average Investment</div>
                                <div class="stat-value legion-stat" id="avg-investment">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Median Investment</div>
                                <div class="stat-value legion-stat" id="median-investment">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Total Sales</div>
                                <div class="stat-value legion-stat" id="total-sales">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Active Sales</div>
                                <div class="stat-value legion-stat" id="active-sales">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Highest Raised</div>
                                <div id="highest-investment-name">
                                    <div class="skeleton skeleton-text mx-auto"></div>
                                </div>
                                <div id="highest-investment-value">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Most Investors</div>
                                <div id="most-investors-name">
                                    <div class="skeleton skeleton-text mx-auto"></div>
                                </div>
                                <div id="most-investors-value">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Highest Average</div>
                                <div id="highest-avg-name">
                                    <div class="skeleton skeleton-text mx-auto"></div>
                                </div>
                                <div id="highest-avg-value">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Lowest Average</div>
                                <div id="lowest-avg-name">
                                    <div class="skeleton skeleton-text mx-auto"></div>
                                </div>
                                <div id="lowest-avg-value">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Lowest Raised</div>
                                <div id="lowest-investment-name">
                                    <div class="skeleton skeleton-text mx-auto"></div>
                                </div>
                                <div id="lowest-investment-value">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Lowest Investors</div>
                                <div id="lowest-investors-name">
                                    <div class="skeleton skeleton-text mx-auto"></div>
                                </div>
                                <div id="lowest-investors-value">
                                    <div class="skeleton skeleton-text-lg mx-auto"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Sales Table -->
                <div class="right-column">
                    <div class="table-container">
                        <!-- Filter Bar -->
                        <div class="filter-bar">
                            <button class="filter-button active" data-sort="default">
                                <i class="fas fa-sort"></i> Default Order
                            </button>
                            <button class="filter-button" data-sort="invested-high">
                                <i class="fas fa-sort-amount-down"></i> Highest Invested
                            </button>
                            <button class="filter-button" data-sort="invested-low">
                                <i class="fas fa-sort-amount-up"></i> Lowest Invested
                            </button>
                            <button class="filter-button" data-sort="investors-high">
                                <i class="fas fa-users"></i> Most Investors
                            </button>
                            <button class="filter-button" data-sort="investors-low">
                                <i class="fas fa-user-minus"></i> Fewest Investors
                            </button>
                            <button class="filter-button" data-sort="upcoming">
                                <i class="fas fa-calendar-alt"></i> Upcoming
                            </button>
                            
                            <div class="search-container">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="search-input" placeholder="Search sales..." id="search-input">
                            </div>
                        </div>
                        
                        <!-- Single scrollable container -->
                        <div class="table-scroll-container">
                            <div class="table-content">
                                <!-- Table Header -->
                                <div class="table-row table-header">
                                    <div></div>
                                    <div>Sale</div>
                                    <div>Invested</div>
                                    <div>Investors</div>
                                    <div>Sale Price</div>
                                    <div>Live Price</div>
                                    <div></div>
                                </div>
                                
                                <!-- Table Body -->
                                <div id="sales-table">
                                    <!-- Table content will be dynamically populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom section -->
            <div class="bottom-section">
                <div class="stats-row">
                    <!-- Investor Count -->
                    <div class="stats-card" id="investor-count">
                        <div class="stats-title">
                            <span>Investor Count by Sale</span>
                            <i class="fas fa-users"></i>
                        </div>
                        <div id="investor-chart-container" class="chart-container">
                            <canvas id="investor-chart"></canvas>
                        </div>
                    </div>

                    <!-- Investment Distribution -->
                    <div class="stats-card" id="investment-distribution">
                        <div class="stats-title">
                            <span>Investment Distribution</span>
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="chart-container">
                            <canvas id="investment-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
const sales = [
    { id: 'almanak', name: 'ALMANAK', className: 'almanak' },
    { id: 'giza', name: 'Giza', className: 'giza' },
    { id: 'skate', name: 'Skate Chain', className: 'skate' },
    { id: 'pulse', name: 'Pulse', className: 'pulse' },
    { id: 'fuel', name: 'FUEL', className: 'fuel' },
    { id: 'electron', name: 'Electron', className: 'electron' },
    { id: 'nil', name: '=nil;', className: 'nil' },
    { id: 'corn', name: 'corn', className: 'corn' },
    { id: 'enclave', name: 'Enclave', className: 'enclave' },
    { id: 'silencio', name: 'Silencio', className: 'silencio' },
    { id: 'lit', name: 'Lit Protocol', className: 'lit' },
    { id: 'resolv', name: 'Resolv', className: 'resolv' }, // No longer active
    { id: 'session', name: 'Session', className: 'session' },
    { id: 'fragmetric', name: 'Fragmetric', className: 'fragmetric' },
    // Other upcoming sales
    { id: 'eoracle', name: 'eOracle', className: 'eoracle', upcoming: true },
    { id: 'overlay', name: 'Overlay', className: 'overlay', upcoming: true }
];
        
// Chart colors that match project branding
const chartColors = {
    almanak: '#a0c4ff',
    giza: '#ffd166',
    skate: '#c5ff33',
    pulse: '#b14aff',
    fuel: '#00f58c',
    electron: '#92c2ff',
    corn: '#ff931e',
    enclave: '#60c2ff',
    nil: '#c9b6e4',
    silencio: '#284ee9',
    lit: '#fd7244', // Lit Protocol color
    resolv: '#6696ae', // Resolv color
    // New colors for upcoming sales
    session: '#24f2d2',
    fragmetric: '#007d3a',
    eoracle: '#1b6a58',
    overlay: '#545454'
};

// Token prices data
const tokenSalePrices = {
    fuel: "0.02",
    silencio: "0.0006",
    skate: "0.08",
    corn: "0.0714"
};

// Token CoinGecko IDs
const coinGeckoIds = {
    fuel: "fuel-network",
    silencio: "silencio",
    lit: "lit-protocol", // Add Lit Protocol CoinGecko ID
    corn: "corn-3"
};

// Store fetched market prices
let marketPrices = {};

// Data storage for all sales
let salesData = [];
let investmentChart = null;
let investorChart = null;
let liveFeedLastUpdate = 0;
let appInitialized = false;  // ADD THIS LINE HERE

// Add global state for visibility and updates
let isPageVisible = true;
let lastUpdateTime = 0;
const UPDATE_COOLDOWN = 5000; // 5 seconds cooldown between updates

// Function to check if we should update
function shouldUpdate() {
    const now = Date.now();
    if (now - lastUpdateTime >= UPDATE_COOLDOWN) {
        lastUpdateTime = now;
        return true;
    }
    return false;
}

// Format currency helper
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

// Format address helper
function formatAddress(address) {
    if (!address) return 'Unknown';
    return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
}

// Function to get token sale price
function getTokenSalePrice(saleId) {
    return tokenSalePrices[saleId] ? `$${tokenSalePrices[saleId]}` : 'N/A';
}

// Function to fetch token prices from CoinGecko
async function fetchTokenPrices() {
    if (!appInitialized) return;
    
    try {
        // Get all available CoinGecko IDs
        const ids = Object.values(coinGeckoIds).filter(id => id);
        
        if (ids.length === 0) return;
        
        // Use our server proxy for each token instead of calling CoinGecko API directly
        const pricePromises = ids.map(id => 
            fetch(`/api/proxy/coingecko/price/${id}`)
                .then(response => response.ok ? response.json() : null)
                .then(data => [id, data])
        );
        
        const results = await Promise.all(pricePromises);
        
        // Update marketPrices object
        for (const [coinId, data] of results) {
            if (data && data.current_price) {
                // Find the sale ID for this coin ID
                const saleId = Object.keys(coinGeckoIds).find(key => coinGeckoIds[key] === coinId);
                if (saleId) {
                    marketPrices[saleId] = data.current_price;
                }
            }
        }
        
        // Update the table with new prices
        updateTable();
    } catch (error) {
        console.error('Error fetching token prices:', error);
    }
}

// Function to get market price display
function getMarketPrice(saleId) {
    if (marketPrices[saleId]) {
        return `$${marketPrices[saleId]}`;
    } else if (coinGeckoIds[saleId]) {
        return `<span class="loading-price">Not Live</span>`;
    } else {
        return `<span class="not-live">Not Live</span>`;
    }
}

// Function to fetch data for a sale
async function fetchSaleData(sale) {
    // Skip if page is not visible
    if (document.visibilityState !== 'visible') return null;
    
    // For upcoming sales, return placeholder data
    if (sale.upcoming) {
        return {
            id: sale.id,
            name: sale.name,
            className: sale.className,
            invested: 0,
            investors: 0,
            avgInvestment: 0,
            highestAllocation: { address: "Unknown", amount: 0 },
            lowestAllocation: { address: "Unknown", amount: 0 },
            tokenSalePrice: 'TBA',
            upcoming: true,
            isActive: false,
            is_live: false
        };
    }
    
    try {
        // Fetch sale stats (includes total, investors, and allocations)
        const statsRes = await fetch(`/api/${sale.id}/stats`);
        if (!statsRes.ok) {
            throw new Error(`Failed to fetch ${sale.id} stats data`);
        }
        const statsData = await statsRes.json();
        
        // Create sale data object with stats
        return {
            id: sale.id,
            name: sale.name,
            className: sale.className,
            invested: statsData.total_investment,
            investors: statsData.total_investors,
            avgInvestment: statsData.average_allocation,
            highestAllocation: statsData.highest_allocation,
            lowestAllocation: statsData.lowest_allocation,
            tokenSalePrice: getTokenSalePrice(sale.id),
            // Mark as active if is_live flag is true
            isActive: statsData.is_live === true,
            is_live: statsData.is_live === true
        };
    } catch (error) {
        console.error(`Error fetching ${sale.id} data:`, error);
        
        // Try the old endpoints as fallback
        try {
            // Skip if page is not visible
            if (document.visibilityState !== 'visible') return null;
            
            // Fetch total investment
            const totalRes = await fetch(`/api/${sale.id}/total-investment`);
            if (!totalRes.ok) {
                throw new Error(`Failed to fetch ${sale.id} investment data`);
            }
            const totalData = await totalRes.json();
            
            // Skip if page is not visible
            if (document.visibilityState !== 'visible') return null;
            
            // Fetch deposits
            const depositsRes = await fetch(`/api/${sale.id}/deposits`);
            if (!depositsRes.ok) {
                throw new Error(`Failed to fetch ${sale.id} deposits data`);
            }
            const depositsData = await depositsRes.json();
            
            const investors = depositsData.count || depositsData.deposits.length;
            
            // Create sale data object
            return {
                id: sale.id,
                name: sale.name,
                className: sale.className,
                invested: totalData.total,
                investors: investors,
                avgInvestment: totalData.total / investors,
                // Default values for allocations
                highestAllocation: { address: "Unknown", amount: 0 },
                lowestAllocation: { address: "Unknown", amount: 0 },
                tokenSalePrice: getTokenSalePrice(sale.id),
                // Check for is_live flag in either response
                isActive: totalData.is_live === true || depositsData.is_live === true,
                is_live: totalData.is_live === true || depositsData.is_live === true
            };
        } catch (fallbackError) {
            console.error(`Fallback also failed for ${sale.id}:`, fallbackError);
            
            // Return a default object for failed fetches
            return {
                id: sale.id,
                name: sale.name,
                className: sale.className,
                invested: 0,
                investors: 0,
                avgInvestment: 0,
                highestAllocation: { address: "Unknown", amount: 0 },
                lowestAllocation: { address: "Unknown", amount: 0 },
                tokenSalePrice: getTokenSalePrice(sale.id),
                isActive: false,
                is_live: false,
                error: true
            };
        }
    }
}

// Function to create a table row for a sale
function createSaleRow(sale) {
    const row = document.createElement('div');
    row.className = `table-row ${sale.className}-row`;
    
    // Check if the sale is live
    const isLive = sale.is_live === true;
    
    // Display the name with a live badge if applicable
    let nameDisplay = sale.name;
    if (isLive) {
        nameDisplay = `${sale.name} <span class="live-badge">LIVE</span>`;
        // Mark as active for the counter
        sale.isActive = true;
    } else if (sale.upcoming) {
        nameDisplay = `${sale.name} <span class="upcoming-badge">UPCOMING</span>`;
    }
    
    const amount = sale.upcoming ? 'TBA' : (sale.error ? 'Error' : `$${parseFloat(sale.invested).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`);
    const investors = sale.upcoming ? 'TBA' : (sale.error ? 'Error' : `${sale.investors.toLocaleString()}`);
    
    row.innerHTML = `
        <div class="logo-container">
            <img 
                src="${sale.id}.jpg" 
                onerror="this.onerror=null; this.src='${sale.id}.png';" 
                alt="${sale.name} Logo" 
                class="sale-logo"
            >
        </div>
        <div class="sale-name">${nameDisplay}</div>
        <div class="sale-amount ${sale.className}-color">${amount}</div>
        <div class="sale-investors">${investors}</div>
        <div class="token-sale-price ${sale.className}-color">${sale.tokenSalePrice}</div>
        <div class="token-price ${sale.className}-color">${sale.upcoming ? 'Not Live' : getMarketPrice(sale.id)}</div>
        <div>
            <a href="${sale.upcoming ? 'https://legion.cc/app/invest' : `/${sale.id}.html`}" target="_blank" class="action-button ${sale.className}-button">${sale.upcoming ? 'Upcoming' : 'View Details'}</a>
        </div>
    `;
    
    return row;
}

// Function to update the table with current sales data
function updateTable(sortType = 'default') {
    const salesTable = document.getElementById('sales-table');
    
    // Abort if table doesn't exist or no sales data
    if (!salesTable || salesData.length === 0) return;
    
    // Clone the sales data for sorting
    let sortedSales = [...salesData];
    
    // Sort based on the specified type
    switch (sortType) {
        case 'invested-high':
            // Split sales into non-upcoming and upcoming
            const nonUpcomingInvestedHigh = sortedSales.filter(sale => !sale.upcoming);
            const upcomingInvestedHigh = sortedSales.filter(sale => sale.upcoming);
            
            // Sort non-upcoming by invested (highest first)
            nonUpcomingInvestedHigh.sort((a, b) => b.invested - a.invested);
            
            // Combine with upcoming at the end
            sortedSales = [...nonUpcomingInvestedHigh, ...upcomingInvestedHigh];
            break;
        case 'invested-low':
            // Split sales into non-upcoming and upcoming
            const nonUpcomingInvested = sortedSales.filter(sale => !sale.upcoming);
            const upcomingInvested = sortedSales.filter(sale => sale.upcoming);
            
            // Sort non-upcoming by invested (lowest first)
            nonUpcomingInvested.sort((a, b) => a.invested - b.invested);
            
            // Combine with upcoming at the end
            sortedSales = [...nonUpcomingInvested, ...upcomingInvested];
            break;
        case 'investors-high':
            // Split sales into non-upcoming and upcoming
            const nonUpcomingInvestorsHigh = sortedSales.filter(sale => !sale.upcoming);
            const upcomingInvestorsHigh = sortedSales.filter(sale => sale.upcoming);
            
            // Sort non-upcoming by investors (highest first)
            nonUpcomingInvestorsHigh.sort((a, b) => b.investors - a.investors);
            
            // Combine with upcoming at the end
            sortedSales = [...nonUpcomingInvestorsHigh, ...upcomingInvestorsHigh];
            break;
        case 'investors-low':
            // Split sales into non-upcoming and upcoming
            const nonUpcomingInvestors = sortedSales.filter(sale => !sale.upcoming);
            const upcomingInvestors = sortedSales.filter(sale => sale.upcoming);
            
            // Sort non-upcoming by investors (lowest first)
            nonUpcomingInvestors.sort((a, b) => a.investors - b.investors);
            
            // Combine with upcoming at the end
            sortedSales = [...nonUpcomingInvestors, ...upcomingInvestors];
            break;
        case 'upcoming':
            // Show upcoming sales first
            sortedSales.sort((a, b) => {
                if (a.upcoming && !b.upcoming) return -1;
                if (!a.upcoming && b.upcoming) return 1;
                return 0;
            });
            break;
        default:
            // Custom order: Live sales first, then past sales in alphabetical order, then upcoming sales
            sortedSales.sort((a, b) => {
                // Live sales first
                if (a.isActive && !b.isActive) return -1;
                if (!a.isActive && b.isActive) return 1;
                
                // If both are active, keep original order (Lit then Resolv)
                if (a.isActive && b.isActive) {
                    return sales.findIndex(s => s.id === a.id) - sales.findIndex(s => s.id === b.id);
                }
                
                // Upcoming sales last
                if (a.upcoming && !b.upcoming) return 1;
                if (!a.upcoming && b.upcoming) return -1;
                
                // Within same category, sort alphabetically
                return a.name.localeCompare(b.name);
            });
            break;
    }
    
    // Apply search filter if any
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    if (searchTerm) {
        sortedSales = sortedSales.filter(sale => 
            sale.name.toLowerCase().includes(searchTerm) || 
            (sale.upcoming ? 'upcoming'.includes(searchTerm) : false) ||
            (!sale.upcoming && formatCurrency(sale.invested).toLowerCase().includes(searchTerm)) ||
            (!sale.upcoming && String(sale.investors).includes(searchTerm))
        );
    }
    
    // Clear the current table
    salesTable.innerHTML = '';
    
    // Populate with sorted sales
    sortedSales.forEach(sale => {
        salesTable.appendChild(createSaleRow(sale));
    });
    
    // Show a message if no results
    if (sortedSales.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'text-center text-gray-500 py-4';
        emptyMessage.textContent = 'No matching sales found.';
        salesTable.appendChild(emptyMessage);
    }
}

// Function to update overall stats
function updateOverallStats() {
    // Skip if no sales data
    if (salesData.length === 0) return;
    
    // Fetch global stats from the API
    fetch('/api/global-stats')
        .then(response => response.json())
        .then(data => {
            console.log("Global stats from API:", data); // Log for debugging
            
            // Update the UI with data directly from the API without modifications
            document.getElementById('total-investment').textContent = formatCurrency(data.total_investment);
            document.getElementById('total-investors').textContent = data.total_investors.toLocaleString();
            document.getElementById('avg-investment').textContent = formatCurrency(data.average_investment);
            document.getElementById('median-investment').textContent = formatCurrency(data.median_investment);
            
            // Continue with the existing code for setting other stats
            // Filter out upcoming sales for stats calculations
            const activeAndCompletedSales = salesData.filter(sale => !sale.upcoming);
            const activeSales = activeAndCompletedSales.filter(sale => sale.isActive).length;
            const totalSales = salesData.length;
            
            document.getElementById('total-sales').textContent = totalSales;
            document.getElementById('active-sales').textContent = activeSales;
            
            // Find highest investment (now labeled "Highest Raised")
            const highestInvestment = activeAndCompletedSales.reduce((max, sale) => 
                sale.invested > max.invested ? sale : max, activeAndCompletedSales[0] || {invested: 0});
            
            document.getElementById('highest-investment-name').textContent = highestInvestment.name || 'N/A';
            document.getElementById('highest-investment-name').className = highestInvestment.className ? `font-bold ${highestInvestment.className}-color` : '';
            document.getElementById('highest-investment-value').textContent = highestInvestment.invested ? formatCurrency(highestInvestment.invested) : 'N/A';
            document.getElementById('highest-investment-value').className = highestInvestment.className ? `stat-value ${highestInvestment.className}-color` : 'stat-value';
            
            // Find most investors
            const mostInvestors = activeAndCompletedSales.reduce((max, sale) => 
                sale.investors > max.investors ? sale : max, activeAndCompletedSales[0] || {investors: 0});
            
            document.getElementById('most-investors-name').textContent = mostInvestors.name || 'N/A';
            document.getElementById('most-investors-name').className = mostInvestors.className ? `font-bold ${mostInvestors.className}-color` : '';
            document.getElementById('most-investors-value').textContent = mostInvestors.investors ? mostInvestors.investors.toLocaleString() : 'N/A';
            document.getElementById('most-investors-value').className = mostInvestors.className ? `stat-value ${mostInvestors.className}-color` : 'stat-value';
            
            // Find lowest investors
            const nonZeroInvestorSales = activeAndCompletedSales.filter(sale => sale.investors > 0);
            const lowestInvestors = nonZeroInvestorSales.length > 0 ? 
                nonZeroInvestorSales.reduce((min, sale) => 
                    sale.investors < min.investors ? sale : min, nonZeroInvestorSales[0]) :
                { name: 'N/A', investors: 0 };
                
            document.getElementById('lowest-investors-name').textContent = lowestInvestors.name;
            document.getElementById('lowest-investors-name').className = lowestInvestors.className ? `font-bold ${lowestInvestors.className}-color` : '';
            document.getElementById('lowest-investors-value').textContent = lowestInvestors.investors ? lowestInvestors.investors.toLocaleString() : 'N/A';
            document.getElementById('lowest-investors-value').className = lowestInvestors.className ? `stat-value ${lowestInvestors.className}-color` : 'stat-value';
            
            // Find lowest investment (now labeled "Lowest Raised")
            const nonZeroInvestmentSales = activeAndCompletedSales.filter(sale => sale.invested > 0);
            const lowestInvestment = nonZeroInvestmentSales.length > 0 ?
                nonZeroInvestmentSales.reduce((min, sale) => 
                    sale.invested < min.invested ? sale : min, nonZeroInvestmentSales[0]) :
                { name: 'N/A', invested: 0 };
                
            document.getElementById('lowest-investment-name').textContent = lowestInvestment.name;
            document.getElementById('lowest-investment-name').className = lowestInvestment.className ? `font-bold ${lowestInvestment.className}-color` : '';
            document.getElementById('lowest-investment-value').textContent = lowestInvestment.invested ? formatCurrency(lowestInvestment.invested) : 'N/A';
            document.getElementById('lowest-investment-value').className = lowestInvestment.className ? `stat-value ${lowestInvestment.className}-color` : 'stat-value';
            
            // Find highest average investment
            const highestAvg = activeAndCompletedSales.reduce((max, sale) => 
                sale.avgInvestment > max.avgInvestment ? sale : max, activeAndCompletedSales[0] || {avgInvestment: 0});
            
            document.getElementById('highest-avg-name').textContent = highestAvg.name || 'N/A';
            document.getElementById('highest-avg-name').className = highestAvg.className ? `font-bold ${highestAvg.className}-color` : '';
            document.getElementById('highest-avg-value').textContent = highestAvg.avgInvestment ? formatCurrency(highestAvg.avgInvestment) : 'N/A';
            document.getElementById('highest-avg-value').className = highestAvg.className ? `stat-value ${highestAvg.className}-color` : 'stat-value';
            
            // Find lowest average investment
            const nonZeroAvgSales = activeAndCompletedSales.filter(sale => sale.avgInvestment > 0);
            const lowestAvg = nonZeroAvgSales.length > 0 ?
                nonZeroAvgSales.reduce((min, sale) => 
                    sale.avgInvestment < min.avgInvestment ? sale : min, nonZeroAvgSales[0]) :
                { name: 'N/A', avgInvestment: 0 };
            
            document.getElementById('lowest-avg-name').textContent = lowestAvg.name;
            document.getElementById('lowest-avg-name').className = lowestAvg.className ? `font-bold ${lowestAvg.className}-color` : '';
            document.getElementById('lowest-avg-value').textContent = lowestAvg.avgInvestment ? formatCurrency(lowestAvg.avgInvestment) : 'N/A';
            document.getElementById('lowest-avg-value').className = lowestAvg.className ? `stat-value ${lowestAvg.className}-color` : 'stat-value';
        })
        .catch(error => {
            console.error('Error fetching global stats:', error);
            
            // Fallback to locally calculated stats if the API fails
            // Filter out upcoming sales for stats calculations
            const activeAndCompletedSales = salesData.filter(sale => !sale.upcoming);
            
            // Calculate overall stats
            const totalInvestment = activeAndCompletedSales.reduce((sum, sale) => sum + sale.invested, 0);
            const totalInvestors = activeAndCompletedSales.reduce((sum, sale) => sum + sale.investors, 0);
            const avgInvestment = totalInvestors > 0 ? totalInvestment / totalInvestors : 0;
            const activeSales = activeAndCompletedSales.filter(sale => sale.isActive).length;
            const totalSales = salesData.length;
            
            // Update the UI
            document.getElementById('total-investment').textContent = formatCurrency(totalInvestment);
            document.getElementById('total-investors').textContent = totalInvestors.toLocaleString();
            document.getElementById('avg-investment').textContent = formatCurrency(avgInvestment);
            document.getElementById('total-sales').textContent = totalSales;
            document.getElementById('active-sales').textContent = activeSales;
            
            // Note: The original median calculation was incorrect, so we're not using it in the fallback
            document.getElementById('median-investment').textContent = "N/A";
            
            // Continue with other stats (highest investment, most investors, etc.)
            // ...rest of the code remains the same for fallback
        });
}

// Function to update charts
function updateCharts() {
    if (salesData.length === 0) return;
    
    // Filter out upcoming sales for chart display
    const activeAndCompletedSales = salesData.filter(sale => !sale.upcoming);
    
    const ctx1 = document.getElementById('investment-chart').getContext('2d');
    const ctx2 = document.getElementById('investor-chart').getContext('2d');
    
    // Prepare chart data
    const labels = activeAndCompletedSales.map(sale => sale.name);
    const investmentValues = activeAndCompletedSales.map(sale => sale.invested);
    const investorValues = activeAndCompletedSales.map(sale => sale.investors);
    const backgroundColors = activeAndCompletedSales.map(sale => chartColors[sale.id]);
    
    // Destroy existing charts if any
    if (investmentChart) investmentChart.destroy();
    if (investorChart) investorChart.destroy();
    
    // Create the investment distribution chart
    investmentChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: investmentValues,
                backgroundColor: backgroundColors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: window.innerWidth < 768 ? 'bottom' : 'right',
                    labels: {
                        color: '#b0b0b0',
                        font: {
                            family: "'Rajdhani', sans-serif",
                            size: window.innerWidth < 768 ? 9 : 11
                        },
                        boxWidth: window.innerWidth < 768 ? 8 : 12,
                        padding: window.innerWidth < 768 ? 6 : 10
                    }
                },
                tooltip: {
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `Amount: ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            },
            cutout: '65%'
        }
    });

    // Create the investor count chart
    investorChart = new Chart(ctx2, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Investors',
                data: investorValues,
                backgroundColor: backgroundColors,
                borderWidth: 0,
                borderRadius: 4,
                barThickness: window.innerWidth < 768 ? 14 : 20 // Adjust bar thickness for mobile
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 13
                    },
                    padding: 12,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return `${context.raw.toLocaleString()} investors`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: '#b0b0b0',
                        font: {
                            family: "'Rajdhani', sans-serif",
                            size: window.innerWidth < 768 ? 9 : 11
                        }
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: '#b0b0b0',
                        font: {
                            family: "'Rajdhani', sans-serif",
                            size: window.innerWidth < 768 ? 9 : 11
                        },
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Function to format time "time ago"
function timeAgo(date) {
    const seconds = Math.floor((new Date() - new Date(date)) / 1000);
    
    if (seconds < 5) return 'just now';
    if (seconds < 60) return `${seconds}s ago`;
    
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m ago`;
    
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h ago`;
    
    const days = Math.floor(hours / 24);
    return `${days}d ago`;
}

// Function to fetch live transactions
async function fetchLiveTransactions() {
    // Skip if app isn't initialized
    if (!appInitialized) return;
    
    // Skip if page is not visible
    if (document.visibilityState !== 'visible') return;
    
    try {
        const response = await fetch('/api/live-feed?limit=10');
        if (!response.ok) {
            throw new Error('Failed to fetch live transactions');
        }
        
        const data = await response.json();
        updateLiveFeed(data.transactions);
        
        // Update last fetch time
        liveFeedLastUpdate = Date.now();
    } catch (error) {
        console.error('Error fetching live transactions:', error);
    }
}

// Function to update the live feed
function updateLiveFeed(transactions) {
    const liveFeed = document.getElementById('live-feed');
    if (!liveFeed) return;
    
    // Clear existing content
    liveFeed.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
        liveFeed.innerHTML = `
            <div class="text-center text-gray-500 py-2">
                <i class="fas fa-info-circle mr-2"></i>
                No Live Sales
            </div>
        `;
        return;
    }
    
    // Add transactions to feed
    transactions.forEach(tx => {
        const feedItem = document.createElement('div');
        feedItem.className = 'feed-item';
        // Store timestamp as data attribute for later updating
        if (tx.timestamp) {
            feedItem.dataset.timestamp = tx.timestamp;
        }
        
        // Determine the sale the transaction belongs to
        const saleId = tx.sale || 'session';
        
        // Determine the correct blockchain explorer link based on the sale
        let explorerUrl;
        if (tx.hash && tx.hash !== "0x0000000000000000000000000000000000000000000000000000000000000000") {
            if (saleId === 'resolv') {
                explorerUrl = `https://etherscan.io/tx/${tx.hash}`;
            } else {
                explorerUrl = `https://arbiscan.io/tx/${tx.hash}`;
            }
        } else {
            // If no valid hash, just use a placeholder link
            explorerUrl = "#";
        }
        
        feedItem.innerHTML = `
            <img src="${saleId}.jpg" onerror="this.src='${saleId}.png'" class="feed-logo" alt="${saleId}">
            <a href="${explorerUrl}" target="_blank" class="feed-address">${formatAddress(tx.from)}</a>
            <span class="feed-amount ${saleId}-color">+$${parseFloat(tx.amount).toFixed(2)}</span>
        `;
        liveFeed.appendChild(feedItem);
    });
}

// Function to update times in the live feed
function updateLiveFeedTimes() {
    const liveFeed = document.getElementById('live-feed');
    if (!liveFeed) return;
    
    const timeElements = liveFeed.querySelectorAll('.feed-time');
    timeElements.forEach(el => {
        // Extract the transaction timestamp from the data attribute
        const txItem = el.closest('.feed-item');
        if (txItem && txItem.dataset.timestamp) {
            el.textContent = timeAgo(txItem.dataset.timestamp);
        }
    });
}

// Add debounce function at the top level
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Function to fetch data for all sales
async function fetchAllSalesData() {
    // Skip if page is not visible or if we shouldn't update
    if (!isPageVisible || !shouldUpdate()) return;
    
    // Clear existing data
    salesData = [];
    
    // Fetch data for each sale
    const promises = sales.map(sale => fetchSaleData(sale));
    const results = await Promise.all(promises);
    
    // Filter out null results (from visibility checks)
    const validResults = results.filter(result => result !== null);
    
    // Update salesData with the results
    salesData = validResults;
    
    // Update UI components
    updateTable();
    updateOverallStats();
    updateCharts();
    
    // Initialize live feed
    initLiveFeed();
    
    // Fetch token prices immediately
    await fetchTokenPrices();
    
    // Set up auto-refresh for active sales (Lit and Resolv)
    let refreshInterval = null;
    let tokenPriceInterval = null;
    
    // Consolidated visibility change handler
    const handleVisibilityChange = () => {
        isPageVisible = document.visibilityState === 'visible';
        
        if (isPageVisible) {
            // Page is visible, start refresh intervals
            refreshInterval = setInterval(refreshActiveData, 60000); // Every minute
            tokenPriceInterval = setInterval(fetchTokenPrices, 300000); // Every 5 minutes
            
            // Fetch data immediately when becoming visible
            if (shouldUpdate()) {
                fetchTokenPrices();
                refreshActiveData();
            }
        } else {
            // Page is hidden, stop all intervals
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            if (tokenPriceInterval) {
                clearInterval(tokenPriceInterval);
                tokenPriceInterval = null;
            }
        }
    };
    
    // Add visibility change listener
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Initial setup
    handleVisibilityChange();
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        if (refreshInterval) clearInterval(refreshInterval);
        if (tokenPriceInterval) clearInterval(tokenPriceInterval);
    });
}

// Function to refresh active sale data
async function refreshActiveData() {
    if (!appInitialized) return;
    
    // Skip if page is not visible or if we shouldn't update
    if (!isPageVisible || !shouldUpdate()) return;
    
    try {
        // Refresh the active sales
        const litIndex = salesData.findIndex(sale => sale.id === 'lit');
        const resolvIndex = salesData.findIndex(sale => sale.id === 'resolv');
        const sessionIndex = salesData.findIndex(sale => sale.id === 'session');
        
        // Fetch updated data for Lit Protocol
        if (litIndex !== -1) {
            const updatedLit = await fetchSaleData(sales.find(sale => sale.id === 'lit'));
            if (updatedLit) {
                salesData[litIndex] = updatedLit;
            }
        }
        
        // Fetch updated data for Resolv
        if (resolvIndex !== -1) {
            const updatedResolv = await fetchSaleData(sales.find(sale => sale.id === 'resolv'));
            if (updatedResolv) {
                salesData[resolvIndex] = updatedResolv;
            }
        }
        
        // Fetch updated data for Session
        if (sessionIndex !== -1) {
            const updatedSession = await fetchSaleData(sales.find(sale => sale.id === 'session'));
            if (updatedSession) {
                salesData[sessionIndex] = updatedSession;
            }
        }
        
        // Update UI components
        updateTable();
        updateOverallStats();
        updateCharts();
        fetchLiveTransactions(); // Refresh the live feed
    } catch (error) {
        console.error('Error refreshing active sale data:', error);
    }
}

// Function to handle window resize
function handleResize() {
    // Update charts when window size changes
    updateCharts();
}

// Set up event listeners for filtering
function setupEventListeners() {
    // Filter buttons
    const filterButtons = document.querySelectorAll('.filter-button');
    filterButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Update active state
            filterButtons.forEach(b => b.classList.remove('active'));
            button.classList.add('active');
            
            // Update table with the selected sort type
            updateTable(button.getAttribute('data-sort'));
        });
    });
    
    // Search input
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', () => {
        // Get the currently active sort type
        const activeButton = document.querySelector('.filter-button.active');
        const sortType = activeButton ? activeButton.getAttribute('data-sort') : 'default';
        
        // Update the table with current sort and search
        updateTable(sortType);
    });
    
    // Add window resize listener for responsive charts
    window.addEventListener('resize', handleResize);
}

// Initialize the page
document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    
    // Check if dashboard is launched
    const dashboardLaunched = localStorage.getItem('dashboardLaunched') === 'true';
    const launchTime = parseInt(localStorage.getItem('dashboardLaunchTime') || '0');
    const currentTime = Date.now();
    
    // If dashboard was launched more than 24 hours ago, reset the flag
    if (launchTime && (currentTime - launchTime > 24 * 60 * 60 * 1000)) {
        localStorage.removeItem('dashboardLaunched');
        localStorage.removeItem('dashboardLaunchTime');
        window.location.href = '/';
        return;
    }
    
    if (dashboardLaunched) {
        // Set appInitialized to true before fetching data
        appInitialized = true;
        // Now it's safe to load data
        fetchAllSalesData();
    } else {
        // If dashboard is not launched, redirect to welcome page
        window.location.href = '/';
    }
    
    // Add mobile scroll hint
    const mobileScrollHint = document.createElement('div');
    mobileScrollHint.className = 'mobile-scroll-hint';
    mobileScrollHint.style.display = window.innerWidth <= 768 ? 'block' : 'none';
    
    window.addEventListener('resize', () => {
        mobileScrollHint.style.display = window.innerWidth <= 768 ? 'block' : 'none';
    });
});

// Function to initialize live feed with real data
function initLiveFeed() {
    // Initialize the live feed to fetch actual data
    const liveFeed = document.getElementById('live-feed');
    
    // Fetch transactions immediately
    fetchLiveTransactions();
    
    // Set up polling intervals for live updates
    let updateInterval = null;
    let timeUpdateInterval = null;
    let lastFetchTime = 0;
    const FETCH_COOLDOWN = 5000; // 5 seconds cooldown between fetches
    
    // Consolidated visibility change handler
    const handleVisibilityChange = () => {
        isPageVisible = document.visibilityState === 'visible';
        
        if (isPageVisible) {
            // Page is visible, start polling with optimized intervals
            if (Date.now() - lastFetchTime >= FETCH_COOLDOWN) {
                fetchLiveTransactions();
                lastFetchTime = Date.now();
            }
            updateInterval = setInterval(() => {
                if (Date.now() - lastFetchTime >= FETCH_COOLDOWN) {
                    fetchLiveTransactions();
                    lastFetchTime = Date.now();
                }
            }, 10000); // Reduced from 30s to 10s for more responsive updates
            timeUpdateInterval = setInterval(updateLiveFeedTimes, 30000); // Reduced from 60s to 30s
        } else {
            // Page is hidden, stop polling
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            if (timeUpdateInterval) {
                clearInterval(timeUpdateInterval);
                timeUpdateInterval = null;
            }
        }
    };
    
    // Add visibility change listener
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Initial setup
    handleVisibilityChange();
    
    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
        document.removeEventListener('visibilitychange', handleVisibilityChange);
        if (updateInterval) clearInterval(updateInterval);
        if (timeUpdateInterval) clearInterval(timeUpdateInterval);
    });
}
    </script>
    
    <!-- Vercel Analytics -->
    <script type="module">
        // Add a cache-busting timestamp
        const timestamp = new Date().getTime();
        const analyticsScript = document.createElement('script');
        analyticsScript.type = 'module';
        analyticsScript.src = `https://cdn.vercel-insights.com/v1.js?t=${timestamp}`;
        
        // When the script loads, inject analytics
        analyticsScript.onload = function() {
            // Access the inject function from the loaded script
            const { inject } = window.VercelAnalytics || {};
            if (typeof inject === 'function') {
                inject();
            } else {
                console.warn('Vercel Analytics inject function not available');
            }
        };
        
        document.head.appendChild(analyticsScript);
    </script>
</body>
</html>
